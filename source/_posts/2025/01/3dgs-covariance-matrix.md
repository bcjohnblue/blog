---
title: 3DGS 協方差矩陣：形狀控制的數學原理
date: 2025-01-24
tags: 
  - 3DGS
  - Computer Vision
  - Machine Learning
  - Linear Algebra
categories:
  - 技術文章
mathjax: true
---

在 3D Gaussian Splatting (3DGS) 中，協方差矩陣 $\Sigma$ 扮演著至關重要的角色。它不僅決定了每個 3D 高斯的形狀和方向，更是整個渲染過程中保證數學穩定性的關鍵。本文將深入探討協方差矩陣的功用、特徵，並詳細解答三個核心問題。

## 🎯 協方差矩陣的功用

### 1. 描述高斯的形狀
協方差矩陣 $\Sigma$ 決定了 3D 高斯的橢球外觀，包括：
- **大小**：矩陣的特徵值決定橢球在各個主軸方向的延伸程度
- **方向**：特徵向量決定橢球的主軸方向

### 2. 控制點雲模糊範圍
在渲染過程中，協方差矩陣影響每個高斯在空間中的「覆蓋範圍」：
- 較大的特徵值 → 在該方向有更大的模糊範圍
- 較小的特徵值 → 在該方向較為集中

### 3. 參與投影到 2D
當 3D 高斯投影到螢幕平面時，協方差矩陣決定了在畫面上的橢圓形 footprint：
$$\Sigma_{2D} = J \Sigma_{3D} J^T$$
其中 $J$ 是雅可比矩陣，描述從 3D 到 2D 的投影變換。

### 4. 保證數學穩定性
透過適當的分解，確保矩陣始終保持合法的數學性質，避免產生不合理的高斯分布。

## 🔍 協方差矩陣的特徵

### 對稱性
協方差矩陣必須是對稱的：$\Sigma^T = \Sigma$

這是因為協方差的定義本身就具有對稱性：
$$\text{Cov}(X_i, X_j) = \text{Cov}(X_j, X_i)$$

### 半正定性 (SPD)
對任意向量 $v$，都有 $v^T \Sigma v \geq 0$

這保證了高斯分布在數學上是合理的，因為機率密度函數中的指數項：
$$\exp\left(-\frac{1}{2}(x-\mu)^T \Sigma^{-1} (x-\mu)\right)$$
需要 $\Sigma^{-1}$ 也是半正定的。

### 分解性
協方差矩陣可以分解為旋轉和縮放的組合：
$$\Sigma = R \, S \, R^T$$

## 🧮 核心問題詳解

### 問題 1：為什麼分解形式是 $\Sigma = R \, S \, R^T$？

這個分解形式來自於**特徵分解（Eigendecomposition）**的幾何意義。

#### 數學推導
任何對稱矩陣都可以進行特徵分解：
$$\Sigma = Q \Lambda Q^T$$
其中：
- $Q$ 是正交矩陣，列向量為特徵向量
- $\Lambda$ 是對角矩陣，對角元素為特徵值

#### 幾何解釋
- $R$（旋轉矩陣）：將標準座標系旋轉到橢球的主軸方向
- $S$（縮放矩陣）：沿著主軸方向進行縮放
- $R^T$：將結果旋轉回原座標系

#### 視覺化理解
想像一個單位球：
1. 首先用 $R^T$ 將座標系旋轉
2. 用 $S$ 將球在各個軸向拉伸成橢球
3. 用 $R$ 將橢球旋轉到最終方向

這樣的分解確保了我們可以獨立控制：
- **形狀**：透過縮放矩陣 $S$ 的對角元素
- **方向**：透過旋轉矩陣 $R$

### 問題 2：為什麼要確保矩陣對稱且半正定？

#### 對稱性的必要性
1. **數學定義**：協方差本身就是對稱的概念
2. **計算效率**：對稱矩陣只需存儲上三角或下三角部分
3. **特徵分解**：只有對稱矩陣才能保證實數特徵值和正交特徵向量

#### 半正定性的必要性

**機率論要求**：
高斯分布的機率密度函數為：
$$p(x) = \frac{1}{(2\pi)^{3/2}|\Sigma|^{1/2}} \exp\left(-\frac{1}{2}(x-\mu)^T \Sigma^{-1} (x-\mu)\right)$$

為了讓這個函數有意義：
- $|\Sigma| > 0$（行列式為正）
- $\Sigma^{-1}$ 必須存在且半正定
- 指數項 $-\frac{1}{2}(x-\mu)^T \Sigma^{-1} (x-\mu) \leq 0$

**幾何意義**：
- 半正定保證了橢球的「內部」是定義良好的
- 如果不是半正定，會出現「鞍點」形狀，在某些方向上機率會無限增大

**數值穩定性**：
- 避免矩陣求逆時的數值問題
- 防止梯度爆炸或消失

### 問題 3：分解後如何維持半正定性？

#### 理論保證

**旋轉矩陣的性質**：
- $R$ 是正交矩陣：$R^T R = I$
- 正交變換保持向量長度：$\|Rv\| = \|v\|$

**縮放矩陣的約束**：
$$S = \begin{pmatrix}
s_1 & 0 & 0 \\
0 & s_2 & 0 \\
0 & 0 & s_3
\end{pmatrix}$$

只要確保 $s_1, s_2, s_3 \geq 0$，就能保證 $S$ 半正定。

#### 數學證明
對任意向量 $v$：
$$v^T \Sigma v = v^T (R S R^T) v = (R^T v)^T S (R^T v)$$

設 $u = R^T v$，則：
$$v^T \Sigma v = u^T S u = s_1 u_1^2 + s_2 u_2^2 + s_3 u_3^2$$

由於 $s_i \geq 0$ 且 $u_i^2 \geq 0$，所以 $v^T \Sigma v \geq 0$。

#### 實作上的保證

**參數化技巧**：
在 3DGS 的實作中，通常使用：
- **四元數**表示旋轉 $R$（自動保證正交性）
- **對數或平方**參數化縮放係數（確保非負）

```python
# 偽代碼示例
def build_covariance_matrix(quaternion, scale):
    # 四元數轉旋轉矩陣，自動正交
    R = quaternion_to_rotation_matrix(quaternion)
    
    # 使用 exp 確保縮放係數為正
    s = torch.exp(scale)  # 或使用 scale^2
    S = torch.diag(s)
    
    # 構建協方差矩陣
    Sigma = R @ S @ R.T
    return Sigma
```

## 🎨 幾何直觀

### 橢球的形成過程
1. **標準球**：$\Sigma = I$（單位矩陣）
2. **縮放**：$\Sigma = S$（沿軸向拉伸）
3. **旋轉**：$\Sigma = R S R^T$（最終橢球）

### 特徵值的意義
- **大特徵值**：橢球在該方向「細長」
- **小特徵值**：橢球在該方向「扁平」
- **相等特徵值**：該方向呈現球形

## 🔧 實際應用

在 3DGS 的訓練過程中：

1. **初始化**：通常從球形高斯開始（$\Sigma = \sigma^2 I$）
2. **優化**：透過梯度下降更新四元數和縮放參數
3. **約束**：確保縮放係數始終為正
4. **投影**：將 3D 協方差矩陣投影到 2D 螢幕空間

## 📝 總結

協方差矩陣在 3DGS 中的重要性不僅在於其數學性質，更在於它提供了一個穩定、可控的方式來描述和操作 3D 高斯的形狀。透過 $\Sigma = R S R^T$ 的分解：

- **分離關注點**：獨立控制形狀和方向
- **保證穩定性**：維持半正定性質
- **便於優化**：提供合適的參數化方式

理解這些原理對於深入掌握 3DGS 技術至關重要，也為後續的改進和應用奠定了堅實的理論基礎。